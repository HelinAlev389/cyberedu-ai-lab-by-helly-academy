{% extends "base.html" %}
{% block content %}
  <h2>üìä SIEM Dashboard</h2>

  {% if log_files %}
    <form method="POST" action="{{ url_for('siem.siem_analyze') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <label for="logfile_select">–ò–∑–±–µ—Ä–∏ –ª–æ–≥ —Ñ–∞–π–ª:</label>
      <select name="logfile" id="logfile_select" class="form-select mb-3">
        {% for file in log_files %}
          <option value="{{ file }}">{{ file }}</option>
        {% endfor %}
      </select>
      <button type="submit" class="btn btn-primary">–ê–Ω–∞–ª–∏–∑–∏—Ä–∞–π</button>
    </form>
  {% else %}
    <div class="alert alert-warning mt-4" role="alert">
      ‚ö†Ô∏è –ù—è–º–∞ –Ω–∞–ª–∏—á–Ω–∏ –ª–æ–≥ —Ñ–∞–π–ª–æ–≤–µ –≤ <code>instance/logs/</code>. –ú–æ–ª—è, –∫–∞—á–∏ –ª–æ–≥–æ–≤–µ.
    </div>
  {% endif %}

  <form action="{{ url_for('siem.upload_log') }}" method="POST" enctype="multipart/form-data" class="mt-5">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="mb-3">
      <label for="log_upload_file" class="form-label">–ö–∞—á–∏ –ª–æ–≥ —Ñ–∞–π–ª (.json):</label>
      <input class="form-control" type="file" id="log_upload_file" name="logfile" accept=".json" required>
    </div>
    <button class="btn btn-success" type="submit">üì§ –ö–∞—á–∏ –ª–æ–≥ —Ñ–∞–π–ª</button>
  </form>

  <form action="{{ url_for('siem.clear_uploaded_logs') }}" method="POST" class="mt-2">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <button type="submit" class="btn btn-outline-danger">üóë –ò–∑—á–∏—Å—Ç–∏ –≤—Å–∏—á–∫–∏ –ª–æ–≥ —Ñ–∞–π–ª–æ–≤–µ</button>
  </form>

  {% if log is defined and log %}
    <h3 class="mt-5">Log:</h3>
    <pre class="bg-dark text-light p-3 rounded">{{ log }}</pre>

    {% if data is defined and data %}
      <div class="card p-4 my-4 bg-light shadow-sm border-start border-success border-4">
        <h4 class="mb-3">üìå –û–±–æ–±—â–µ–Ω–∏–µ –Ω–∞ –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞</h4>
        <ul>
          <li><strong>–î–∞—Ç–∞ –∏ —á–∞—Å:</strong> {{ data[0].get("timestamp", "–Ω—è–º–∞ –¥–∞—Ç–∞") }}</li>
          <li><strong>–¢–∏–ø –Ω–∞ —Å—ä–±–∏—Ç–∏–µ—Ç–æ:</strong> {{ data[0].get("event_type") or data[0].get("event", "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ") }}</li>
          <li><strong>–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª:</strong> {{ data[0].get("user", "–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω") }}</li>
          <li><strong>–î–µ–π—Å—Ç–≤–∏–µ:</strong> {{ data[0].get("action", "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ") }}</li>
          <li><strong>–õ–æ–∫–∞—Ü–∏—è:</strong> {{ data[0].get("location", "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ") }}</li>
        </ul>

        <h5 class="mt-4">üß† –ê–Ω–∞–ª–∏–∑</h5>
        <div class="bg-light p-3 rounded border" style="white-space: pre-wrap; word-break: break-word;">
          {{ ai_analysis }}
        </div>

        <h5 class="mt-4">–ü—Ä–µ–ø–æ—Ä—ä–∫–∏</h5>
        <ul>
          <li>–ü—Ä–æ–≤–µ—Ä–∏ –¥–∞–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ—Ç–æ –µ –æ–¥–æ–±—Ä–µ–Ω–æ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä.</li>
          <li>–ò–∑–æ–ª–∏—Ä–∞–π –º–∞—à–∏–Ω–∞—Ç–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –∏ –ø—Ä–æ–≤–µ—Ä–∏ –ª–æ–≥–æ–≤–µ –æ—Ç –ø—Ä–µ–¥–∏/—Å–ª–µ–¥ —Ç–æ–≤–∞.</li>
          <li>–ü—Ä–µ–≥–ª–µ–¥–∞–π –¥–µ–π—Å—Ç–≤–∏—è—Ç–∞ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è "{{ data[0].get("user", "–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω") }}".</li>
        </ul>
      </div>

      <h3>–ì—Ä–∞—Ñ–∏–∫–∞:</h3>
      <canvas id="logChart" width="400" height="200"></canvas>
      <script>
        const chartData = {{ chart_data | tojson | safe }};
        const ctx = document.getElementById('logChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: chartData.labels,
            datasets: [{
              label: '–ë—Ä–æ–π —Å—ä–±–∏—Ç–∏—è',
              data: chartData.values,
            }]
          },
          options: {
            plugins: {
              tooltip: {
                callbacks: {
                  label: (ctx) => chartData.tooltips[ctx.dataIndex]
                }
              }
            }
          }
        });
      </script>

      <div class="alert alert-info mt-4">
        ‚ÑπÔ∏è –û–±—â–æ —Å—ä–±–∏—Ç–∏—è: <strong>{{ chart_data['values'] | sum }}</strong>
        ‚ÑπÔ∏è –í–∏–¥–æ–≤–µ —Å—ä–±–∏—Ç–∏—è: <strong>{{ chart_data.labels | length }}</strong>
      </div>

      <form method="POST" action="{{ url_for('siem.export_pdf') }}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <textarea name="log_data" style="display:none;">{{ log }}</textarea>
        <textarea name="ai_output" style="display:none;">{{ ai_analysis }}</textarea>
        <button class="btn btn-outline-primary mt-3" type="submit">üìÑ –ï–∫—Å–ø–æ—Ä—Ç–∏—Ä–∞–π –∫–∞—Ç–æ PDF</button>
      </form>
    {% else %}
      <div class="alert alert-warning mt-4">‚ö†Ô∏è –ù—è–º–∞ –Ω–∞–ª–∏—á–Ω–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–∞–Ω–∏ –¥–∞–Ω–Ω–∏ –∑–∞ –æ–±–æ–±—â–µ–Ω–∏–µ.</div>
    {% endif %}
  {% endif %}

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="{{ url_for('static', filename='chart.js') }}"></script>
{% endblock %}
