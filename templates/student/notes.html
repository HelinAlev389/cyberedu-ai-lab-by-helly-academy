{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">üìò –ú–æ–∏—Ç–µ –±–µ–ª–µ–∂–∫–∏</h2>

  {% if notes %}
    <div class="row">
      {% for note in notes %}
        <div class="col-md-6 col-lg-4 mb-4">
          <div class="card shadow-sm border-0 h-100">
            <div class="card-body d-flex flex-column">
              <h5 class="card-title text-primary">{{ note.lesson.title }}</h5>

              {% if active_note and active_note.id == note.id %}
                <!-- ‚úèÔ∏è Edit Mode -->
                <form method="POST" onsubmit="syncEditor({{ note.id }})">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                  <input type="hidden" name="note_id" value="{{ note.id }}">
                  <input type="hidden" name="content" id="hidden-content-{{ note.id }}">

                  <div id="editor-{{ note.id }}" class="quill-editor" style="height: 200px;">
                    {{ note.content | safe }}
                  </div>

                  <div class="d-flex justify-content-between mt-2">
                    <button type="submit" name="action" value="save" class="btn btn-success btn-sm">üíæ –ó–∞–ø–∞–∑–∏</button>
                    <a href="{{ url_for('student_dashboard.all_notes') }}" class="btn btn-secondary btn-sm">‚ùå –û—Ç–∫–∞–∑</a>
                  </div>
                </form>

              {% elif improved_note and active_note.id == note.id %}
                <!-- ‚ú® AI Improved Mode -->
                <form method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                  <input type="hidden" name="note_id" value="{{ note.id }}">
                  <label class="form-label">‚ú® AI –ø–æ–¥–æ–±—Ä–µ–Ω–∞ –≤–µ—Ä—Å–∏—è:</label>
                  <textarea name="improved_content" class="form-control" rows="6">{{ improved_note }}</textarea>
                  <div class="d-flex justify-content-between mt-2">
                    <button type="submit" name="action" value="save_ai" class="btn btn-success btn-sm">üíæ –ó–∞–ø–∞–∑–∏ AI –≤–µ—Ä—Å–∏—è—Ç–∞</button>
                    <a href="{{ url_for('student_dashboard.all_notes') }}" class="btn btn-secondary btn-sm">‚ùå –û—Ç–∫–∞–∑</a>
                  </div>
                </form>

              {% else %}
                <!-- üëÅÔ∏è View Mode -->
                <div class="note-content mb-3">
                  {{ note.content | safe }}
                </div>
                <div class="d-flex justify-content-between mt-2">
                  <form method="POST" class="d-inline">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <input type="hidden" name="note_id" value="{{ note.id }}">
                    <button type="submit" name="action" value="edit" class="btn btn-sm btn-primary">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button>
                    <button type="submit" name="action" value="improve" class="btn btn-sm btn-warning">‚ú® AI –ü–æ–¥–æ–±—Ä–∏</button>
                  </form>
                  <form method="POST" class="d-inline" onsubmit="return confirm('–°–∏–≥—É—Ä–Ω–∏ –ª–∏ —Å—Ç–µ, —á–µ –∏—Å–∫–∞—Ç–µ –¥–∞ –∏–∑—Ç—Ä–∏–µ—Ç–µ –±–µ–ª–µ–∂–∫–∞—Ç–∞?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <input type="hidden" name="note_id" value="{{ note.id }}">
                    <button type="submit" name="action" value="delete" class="btn btn-sm btn-danger">üóëÔ∏è –ò–∑—Ç—Ä–∏–π</button>
                  </form>
                </div>
              {% endif %}

            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="text-muted">–ù—è–º–∞—Ç–µ –∑–∞–ø–∞–∑–µ–Ω–∏ –±–µ–ª–µ–∂–∫–∏.</p>
  {% endif %}
</div>

<!-- Quill init script -->
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.quill-editor').forEach(editorEl => {
      const quill = new Quill(editorEl, {
        theme: 'snow',
        modules: {
          toolbar: [['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['link', 'image'], [{ 'align': [] }], ['clean']]
        }
      });
      editorEl.__quill = quill;
    });
  });

  function syncEditor(noteId) {
    const quill = document.querySelector(`#editor-${noteId}`).__quill;
    document.querySelector(`#hidden-content-${noteId}`).value = quill.root.innerHTML;
  }
</script>
{% endblock %}