{% extends "base.html" %}

{% block content %}
  <h2>{{ scenario.title }}</h2>
  <p>{{ scenario.description }}</p>

  {% if log_data %}
    <h4>游늯 Log 혟햟햧햩:</h4>
    <pre><code>{{ log_data | tojson(indent=2) }}</code></pre>
  {% endif %}

  {% if scenario.steps %}
  <form id="walkthrough-form">
    <h4>游댌 햐혝혥햨햦 향햟 햟햫햟햩햦향:</h4>
    {% for step in scenario.steps %}
      <div class="mb-3">
        <label><strong>{{ loop.index }}. {{ step }}</strong></label>
        <textarea name="answer{{ loop.index }}" class="form-control" rows="3" required></textarea>
      </div>
    {% endfor %}
    <button type="submit" class="btn btn-success">햊향햟혝햦 향햟 AI 쮐햣햫햨햟</button>
  </form>
  {% endif %}

  <div id="ai-feedback" class="mt-4"></div>

  <script>
    document.getElementById("walkthrough-form")?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const form = e.target;
      const answers = Array.from(form.elements)
        .filter(el => el.name.startsWith("answer"))
        .map(el => el.value.trim());

      const response = await fetch("/ai-walkthrough-feedback", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ answers })
      });

      const result = await response.json();
      document.getElementById("ai-feedback").innerHTML =
        `<h5>游 AI 쮐햣햫햨햟:</h5><div class="alert alert-info">${result.feedback.replaceAll('\n', '<br>')}</div>`;
    });
  </script>
{% endblock %}
