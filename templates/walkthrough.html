{% extends "base.html" %}

{% block content %}
<h2>{{ scenario.title }}</h2>
<p>{{ scenario.description }}</p>

{% if log_data %}
  <h5>üìÑ Log —Ñ–∞–π–ª:</h5>
  <pre><code>{{ log_data | tojson(indent=2) }}</code></pre>
{% endif %}

{% if scenario.steps %}
  <div id="walkthrough-container" class="mt-4">
    <div id="step-box" class="card p-3 mb-3">
      <h5 id="step-title"></h5>
      <textarea id="answer-input" class="form-control mt-2 mb-3" rows="4" placeholder="–í—ä–≤–µ–¥–∏ –æ—Ç–≥–æ–≤–æ—Ä–∞ —Å–∏..."></textarea>
      <button id="next-btn" class="btn btn-primary">–°–ª–µ–¥–≤–∞—â–∞ —Å—Ç—ä–ø–∫–∞</button>
    </div>
  </div>
  <div id="ai-feedback" class="mt-4"></div>
{% endif %}

<script>
  const steps = {{ scenario.steps | tojson }};
  let currentStep = 0;
  let answers = [];

  const stepTitle = document.getElementById("step-title");
  const answerInput = document.getElementById("answer-input");
  const nextBtn = document.getElementById("next-btn");

  function showStep(index) {
    stepTitle.textContent = `${index + 1}. ${steps[index]}`;
    answerInput.value = "";
    answerInput.focus();
  }

  nextBtn.addEventListener("click", async () => {
    const ans = answerInput.value.trim();
    if (!ans) return alert("–ú–æ–ª—è –≤—ä–≤–µ–¥–∏ –æ—Ç–≥–æ–≤–æ—Ä.");

    answers.push(ans);
    currentStep++;

    if (currentStep < steps.length) {
      showStep(currentStep);
    } else {
      document.getElementById("walkthrough-container").innerHTML = "<p>‚è≥ –ò–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ –æ—Ç–≥–æ–≤–æ—Ä–∏—Ç–µ –∑–∞ –∞–Ω–∞–ª–∏–∑...</p>";

      const res = await fetch("/ai-walkthrough-feedback", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ answers })
      });

      const data = await res.json();

      document.getElementById("ai-feedback").innerHTML = `
        <h4>üß† AI –û—Ü–µ–Ω–∫–∞</h4>
        <div class="alert alert-info" id="feedback-content">${data.feedback.replaceAll("\n", "<br>")}</div>

        <div class="mt-4 d-flex flex-wrap gap-2">
          <a href="${location.pathname}" class="btn btn-outline-secondary">üîÅ –ü–æ–≤—Ç–æ—Ä–∏ –º–∏—Å–∏—è—Ç–∞</a>
          <a href="/walkthroughs" class="btn btn-outline-primary">üè† –í—ä—Ä–Ω–∏ —Å–µ –∫—ä–º –≥–ª–∞–≤–Ω–æ—Ç–æ –º–µ–Ω—é</a>
          <button class="btn btn-outline-success" onclick="exportPDF()">üìÑ –ò–∑—Ç–µ–≥–ª–∏ PDF –æ—Ç—á–µ—Ç</button>
        </div>
      `;
    }
  });

  // üü¢ –ò–∑–Ω–µ—Å–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è (–≥–ª–æ–±–∞–ª–Ω–æ –¥–æ—Å—Ç—ä–ø–Ω–∞)
  async function exportPDF() {
    const feedback = document.getElementById("feedback-content").innerText;
    const res = await fetch("/walkthrough-pdf", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        steps: steps,
        answers: answers,
        feedback: feedback
      })
    });

    if (res.ok) {
      const blob = await res.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "walkthrough_report.pdf";
      a.click();
      window.URL.revokeObjectURL(url);
    } else {
      alert("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∏—Ä–∞–Ω–µ –Ω–∞ PDF.");
    }
  }

  // üîπ –°—Ç–∞—Ä—Ç–∏—Ä–∞–π
  showStep(currentStep);
</script>


{% endblock %}
