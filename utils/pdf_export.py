from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont
from reportlab.lib.units import mm
import os
import datetime
import re


def sanitize_filename(name: str) -> str:
    """–ü—Ä–µ–º–∞—Ö–≤–∞ –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–∏ —Å–∏–º–≤–æ–ª–∏ –∑–∞ —Ñ–∞–π–ª–æ–≤–æ –∏–º–µ"""
    return re.sub(r'[^\w\-_.]', '_', name)


def export_to_pdf(log_text: str, gpt_response: str, filename: str):
    os.makedirs(os.path.dirname(filename), exist_ok=True)

    # ‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ —à—Ä–∏—Ñ—Ç —Å –∫–∏—Ä–∏–ª–∏—Ü–∞
    font_path = os.path.join("static", "fonts", "DejaVuSans.ttf")
    if not os.path.exists(font_path):
        raise FileNotFoundError(f"‚ùå –®—Ä–∏—Ñ—Ç—ä—Ç –Ω–µ –µ –Ω–∞–º–µ—Ä–µ–Ω: {font_path}")

    pdfmetrics.registerFont(TTFont("DejaVu", font_path))

    c = canvas.Canvas(filename, pagesize=A4)
    width, height = A4
    y = height - 40

    # –ó–∞–≥–ª–∞–≤–∏–µ
    c.setFont("DejaVu", 14)
    c.drawString(40, y, "CyberEdu AI SOC Report")
    y -= 30

    # –õ–æ–≥ —Å–µ–∫—Ü–∏—è
    c.setFont("DejaVu", 11)
    c.drawString(40, y, "–õ–æ–≥ –∏–ª–∏ –≤—Ö–æ–¥–Ω–∏ –¥–∞–Ω–Ω–∏:")
    y -= 20

    c.setFont("DejaVu", 9)
    for line in log_text.splitlines():
        c.drawString(40, y, line)
        y -= 12
        if y < 70:
            draw_footer(c, width)
            c.showPage()
            c.setFont("DejaVu", 9)
            y = height - 40

    # AI –∞–Ω–∞–ª–∏–∑
    y -= 10
    c.setFont("DejaVu", 11)
    c.drawString(40, y, "üß† AI –∞–Ω–∞–ª–∏–∑:")
    y -= 20

    c.setFont("DejaVu", 10)
    for line in gpt_response.splitlines():
        c.drawString(40, y, line)
        y -= 13
        if y < 70:
            draw_footer(c, width)
            c.showPage()
            c.setFont("DejaVu", 10)
            y = height - 40

    draw_footer(c, width)
    c.save()


def draw_footer(c, width):
    """–î–æ–±–∞–≤—è —Ñ—É—Ç—ä—Ä —Å –¥–∞—Ç–∞ –∏ –∞–≤—Ç–æ—Ä—Å—Ç–≤–æ"""
    c.setFont("Helvetica-Oblique", 8)
    c.setFillGray(0.4)
    footer_text = f"Generated by CyberEdu AI Lab | {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
    c.drawCentredString(width / 2, 20, footer_text)
