from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
from reportlab.lib.units import mm
import os
import datetime
import re


def sanitize_filename(name: str) -> str:
    """–ü—Ä–µ–º–∞—Ö–≤–∞ –Ω–µ–ø–æ–¥—Ö–æ–¥—è—â–∏ —Å–∏–º–≤–æ–ª–∏ –∑–∞ —Ñ–∞–π–ª–æ–≤–æ –∏–º–µ"""
    return re.sub(r'[^\w\-_.]', '_', name)



def export_to_pdf(log_text: str, gpt_response: str, filename: str):
    os.makedirs(os.path.dirname(filename), exist_ok=True)
    c = canvas.Canvas(filename, pagesize=A4)
    width, height = A4
    y = height - 40

    # –ó–∞–≥–ª–∞–≤–∏–µ
    c.setFont("Helvetica-Bold", 14)
    c.drawString(40, y, "CyberEdu AI SOC Report")
    y -= 30

    # üñº –î–æ–±–∞–≤–∏ –ª–æ–≥–æ (–ø–æ –∏–∑–±–æ—Ä ‚Äî –∞–∫–æ –∏–º–∞—à .png —Ñ–∞–π–ª)
    # try:
    #     c.drawImage("static/assets/logo.png", width - 120, height - 70, width=70, preserveAspectRatio=True)
    # except:
    #     pass  # –∞–∫–æ –Ω—è–º–∞ –ª–æ–≥–æ—Ç–æ, –Ω–µ –∫—Ä–∞—à–≤–∞–º–µ

    # Log Section
    c.setFont("Helvetica-Bold", 11)
    c.drawString(40, y, "Log:")
    y -= 20

    c.setFont("Courier", 9)
    for line in log_text.splitlines():
        c.drawString(40, y, line)
        y -= 12
        if y < 70:
            draw_footer(c, width)
            c.showPage()
            y = height - 40

    # AI Analysis
    y -= 10
    c.setFont("Helvetica-Bold", 11)
    c.drawString(40, y, "GPT Analysis:")
    y -= 20

    c.setFont("Helvetica", 10)
    for line in gpt_response.splitlines():
        c.drawString(40, y, line)
        y -= 13
        if y < 70:
            draw_footer(c, width)
            c.showPage()
            y = height - 40

    # –§–∏–Ω–∞–ª–µ–Ω —Ñ—É—Ç—ä—Ä
    draw_footer(c, width)
    c.save()


def draw_footer(c, width):
    """–î–æ–±–∞–≤—è —Ñ—É—Ç—ä—Ä —Å –¥–∞—Ç–∞ –∏ –∞–≤—Ç–æ—Ä—Å—Ç–≤–æ"""
    c.setFont("Helvetica-Oblique", 8)
    c.setFillGray(0.4)
    footer_text = f"Generated by CyberEdu AI Lab | {datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}"
    c.drawCentredString(width / 2, 20, footer_text)
